<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodexMiroir - Task Management</title>
    
    <!-- Pico CSS -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body x-data="appData()" x-init="init()">
    <div class="main-container">
        <!-- View 1: Main View -->
        <div x-show="currentView === 'main'">
            <!-- Current Task -->
            <div class="current-task">
                <h2>Aktuelle Aufgabe</h2>
                <div x-show="currentTask">
                    <h3 x-text="currentTask?.title || 'Keine aktuelle Aufgabe'"></h3>
                    <p x-text="currentTask?.description || ''"></p>
                    <small x-text="formatDate(new Date())"></small>
                </div>
                <div x-show="!currentTask">
                    <p>Keine Aufgabe f√ºr den aktuellen Zeitpunkt</p>
                </div>
            </div>

            <!-- Input Buttons -->
            <div class="input-buttons">
                <button class="voice-btn" 
                        :class="{ 'listening': isListening }"
                        @click="openVoiceModal()" 
                        @mousedown="startLongPress()" 
                        @mouseup="endLongPress()"
                        @touchstart="startLongPress()" 
                        @touchend="endLongPress()">
                    <span>üé§</span>
                    <span x-text="isListening ? 'H√∂re zu...' : 'Spracheingabe'"></span>
                </button>
                
                <button class="text-btn" @click="openTextModal()">
                    <span>‚úçÔ∏è</span>
                    <span>Texteingabe</span>
                </button>
            </div>

            <!-- Daily Tasks Container -->
            <div class="daily-tasks">
                <div class="day-header">
                    <h3 x-text="formatDayHeader(currentDate)"></h3>
                    <small x-text="'KW ' + getWeekNumber(currentDate)"></small>
                </div>
                
                <!-- Navigation Arrows -->
                <div class="nav-arrows">
                    <button class="nav-btn" @click="scrollToPreviousDay()" :disabled="!canScrollUp">
                        <span>‚Üê</span>
                    </button>
                    <button class="nav-btn" @click="scrollToNextDay()" :disabled="!canScrollDown">
                        <span>‚Üí</span>
                    </button>
                </div>

                <!-- Tasks List -->
                <div class="scroll-container">
                    <template x-for="task in todaysTasks" :key="task.id">
                        <div class="task-item">
                            <h4 x-text="task.title"></h4>
                            <p x-text="task.description"></p>
                            <small x-text="task.deadline"></small>
                        </div>
                    </template>
                    <div x-show="todaysTasks.length === 0">
                        <p>Keine Aufgaben f√ºr heute</p>
                    </div>
                </div>
            </div>

            <!-- Settings Button -->
            <button @click="openSettingsModal()" style="position: fixed; bottom: 20px; right: 20px; border-radius: 50%; width: 50px; height: 50px;">
                ‚öôÔ∏è
            </button>
        </div>

        <!-- View 2: Voice Recording Modal -->
        <div class="modal" :class="{ 'show': currentView === 'voice' }">
            <div class="modal-content">
                <div class="recording-indicator">
                    <div class="recording-circle">
                        üé§
                    </div>
                    <h3>Sprechen Sie jetzt...</h3>
                    <p x-text="'Verbleibende Zeit: ' + recordingTimeLeft + 's'"></p>
                    <button @click="stopRecording()">Beenden</button>
                </div>
            </div>
        </div>

        <!-- View 3: Text Input Modal -->
        <div class="modal" :class="{ 'show': currentView === 'text' }">
            <div class="modal-content">
                <h3>Neue Aufgabe erstellen</h3>
                <form @submit.prevent="saveTask()">
                    <div class="form-group">
                        <label>Titel</label>
                        <input type="text" x-model="newTask.title" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Notiz</label>
                        <textarea x-model="newTask.description" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Deadline</label>
                        <input type="date" x-model="newTask.deadline">
                    </div>
                    
                    <div class="form-group">
                        <label>Projekt</label>
                        <input type="text" x-model="newTask.project">
                    </div>
                    
                    <div class="form-group">
                        <label>Tags</label>
                        <input type="text" x-model="newTask.tags" placeholder="Tag1, Tag2, Tag3">
                    </div>
                    
                    <div>
                        <button type="submit">Speichern</button>
                        <button type="button" @click="closeModal()">Abbrechen</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- View 4: Settings Modal -->
        <div class="modal" :class="{ 'show': currentView === 'settings' }">
            <div class="modal-content">
                <h3>Einstellungen</h3>
                <div>
                    <h4>Aktuelles Token</h4>
                    <div class="token-display" x-text="currentToken || 'Kein Token gesetzt'"></div>
                    <button @click="copyToken()">Token kopieren</button>
                </div>
                <button @click="closeModal()">Schlie√üen</button>
            </div>
        </div>
    </div>

    <!-- Alpine.js App Logic -->
    <script>
        function appData() {
            return {
                // Views
                currentView: 'main',
                
                // Data
                currentTask: null,
                tasks: [],
                todaysTasks: [],
                currentDate: new Date(),
                currentToken: '',
                
                // Voice/Input states  
                isListening: false,
                recordingTimeLeft: 10,
                recordingTimer: null,
                longPressTimer: null,
                
                // Form data
                newTask: {
                    title: '',
                    description: '',
                    deadline: '',
                    project: '',
                    tags: ''
                },
                
                // Navigation
                canScrollUp: true,
                canScrollDown: true,

                // Initialization
                init() {
                    this.loadToken();
                    this.loadTasks();
                    this.setupEventListeners();
                    this.updateCurrentTask();
                },

                // Event listeners for custom events
                setupEventListeners() {
                    window.addEventListener('scrollUp', () => this.scrollToPreviousDay());
                    window.addEventListener('scrollDown', () => this.scrollToNextDay());
                    window.addEventListener('longPressStart', () => this.openVoiceModal());
                    window.addEventListener('longPressEnd', () => this.closeVoiceModal());
                },

                // Date/Time functions
                formatDate(date) {
                    return date.toLocaleDateString('de-DE', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },

                formatDayHeader(date) {
                    return date.toLocaleDateString('de-DE', { 
                        weekday: 'long', 
                        day: 'numeric',
                        month: 'long'
                    });
                },

                getWeekNumber(date) {
                    const target = new Date(date.valueOf());
                    const dayNumber = (date.getUTCDay() + 6) % 7;
                    target.setUTCDate(target.getUTCDate() - dayNumber + 3);
                    const firstThursday = target.valueOf();
                    target.setUTCMonth(0, 1);
                    if (target.getUTCDay() !== 4) {
                        target.setUTCMonth(0, 1 + ((4 - target.getUTCDay()) + 7) % 7);
                    }
                    return 1 + Math.ceil((firstThursday - target) / 604800000);
                },

                // Modal controls
                openVoiceModal() {
                    this.currentView = 'voice';
                    this.startVoiceRecording();
                },

                openTextModal() {
                    this.currentView = 'text';
                    this.resetNewTask();
                },

                openSettingsModal() {
                    this.currentView = 'settings';
                },

                closeModal() {
                    this.currentView = 'main';
                    this.stopRecording();
                },

                closeVoiceModal() {
                    if (this.currentView === 'voice') {
                        this.closeModal();
                    }
                },

                // Voice Recording
                startVoiceRecording() {
                    if (!('webkitSpeechRecognition' in window)) {
                        alert('Spracherkennung wird nicht unterst√ºtzt');
                        return;
                    }

                    this.isListening = true;
                    this.recordingTimeLeft = 10;
                    
                    this.recordingTimer = setInterval(() => {
                        this.recordingTimeLeft--;
                        if (this.recordingTimeLeft <= 0) {
                            this.stopRecording();
                        }
                    }, 1000);

                    // TODO: Implement actual speech recognition
                    console.log('Voice recording started');
                },

                stopRecording() {
                    this.isListening = false;
                    if (this.recordingTimer) {
                        clearInterval(this.recordingTimer);
                        this.recordingTimer = null;
                    }
                    console.log('Voice recording stopped');
                },

                // Long press handling
                startLongPress() {
                    this.longPressTimer = setTimeout(() => {
                        window.dispatchEvent(new CustomEvent('longPressStart'));
                    }, 500);
                },

                endLongPress() {
                    if (this.longPressTimer) {
                        clearTimeout(this.longPressTimer);
                        this.longPressTimer = null;
                    }
                    window.dispatchEvent(new CustomEvent('longPressEnd'));
                },

                // Navigation
                scrollToPreviousDay() {
                    this.currentDate.setDate(this.currentDate.getDate() - 1);
                    this.updateTodaysTasks();
                    window.dispatchEvent(new CustomEvent('scrollUp'));
                },

                scrollToNextDay() {
                    this.currentDate.setDate(this.currentDate.getDate() + 1);
                    this.updateTodaysTasks();
                    window.dispatchEvent(new CustomEvent('scrollDown'));
                },

                // Task management
                resetNewTask() {
                    this.newTask = {
                        title: '',
                        description: '',
                        deadline: '',
                        project: '',
                        tags: ''
                    };
                },

                saveTask() {
                    const task = {
                        id: Date.now(),
                        ...this.newTask,
                        created: new Date().toISOString(),
                        status: 'pending'
                    };
                    
                    this.tasks.push(task);
                    this.updateTodaysTasks();
                    this.updateCurrentTask();
                    this.closeModal();
                    console.log('Task saved:', task);
                },

                loadTasks() {
                    // TODO: Load from API
                    this.tasks = [];
                    this.updateTodaysTasks();
                },

                updateTodaysTasks() {
                    const today = this.currentDate.toDateString();
                    this.todaysTasks = this.tasks.filter(task => 
                        new Date(task.deadline).toDateString() === today
                    );
                },

                updateCurrentTask() {
                    // Get the first pending task for today
                    this.currentTask = this.todaysTasks.find(task => task.status === 'pending') || null;
                },

                // Token management
                loadToken() {
                    this.currentToken = localStorage.getItem('codexToken') || '';
                },

                copyToken() {
                    if (this.currentToken) {
                        navigator.clipboard.writeText(this.currentToken);
                        alert('Token kopiert!');
                    }
                }
            };
        }
    </script>
</body>
</html>