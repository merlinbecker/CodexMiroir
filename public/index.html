<!doctype html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=240, height=282, user-scalable=no, initial-scale=1.0">
    <title>Codex Miroir - Timeline</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body class="timeline-page">
    <!-- Loading Spinner Overlay -->
    <div id="loadingOverlay">
        <div>
            <div class="spinner"></div>
            <p>Wird geladen...</p>
        </div>
    </div>

    <header>
        <h1>Codex Miroir</h1>
        <div class="nav">
            <a href="#" id="createTaskLink">+ Neue Task erstellen</a>
            <button id="fullSyncBtn">ðŸ”„ Full Sync</button>
            <button id="logoutBtn">Abmelden</button>
        </div>
        <p id="nextIdDisplay"></p>
    </header>

    <div id="timeline">
        <div class="loading">Timeline wird geladen...</div>
    </div>

    <script type="text/javascript">
        console.log('[DEBUG] Script started loading');

        const dayNames = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
        console.log('[DEBUG] dayNames defined');

        // Loading spinner functions
        function showLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'flex';
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        function extractTaskNumber(filename) {
            const match = filename.match(/(\d{4})/);
            return match ? parseInt(match[1], 10) : 9999;
        }

        async function loadTimeline() {
            const container = document.getElementById('timeline');
            showLoading();
            try {
                console.log('[Timeline] Starting load...');
                const apiUrl = '/codex';
                console.log('[Timeline] API URL:', apiUrl);
                const response = await fetch(apiUrl);
                console.log('[Timeline] Response status:', response.status);
                const data = await response.json();
                console.log('[Timeline] Data received:', data);

                // Zeige nÃ¤chste verfÃ¼gbare ID und Cache-Zeit an
                const nextIdDisplay = document.getElementById('nextIdDisplay');
                if (data.nextAvailableId) {
                    const cacheTime = data.cacheCreatedAt ? new Date(data.cacheCreatedAt).toLocaleString('de-DE') : 'unbekannt';
                    nextIdDisplay.innerHTML = `<strong>NÃ¤chste Task-ID:</strong> ${data.nextAvailableId} | <strong>Cache erstellt:</strong> ${cacheTime}`;
                } else {
                    nextIdDisplay.innerHTML = '<em style="color: #999;">Lade Informationen...</em>';
                }

                if (!data.timeline || !Array.isArray(data.timeline)) {
                    container.innerHTML = '<div class="empty">Keine Zeitachsen-Daten gefunden.</div>';
                    return;
                }

                let html = '';
                for (const day of data.timeline || []) {
                    const dayName = dayNames[day.dayOfWeek];
                    html += `<div class="day">
                        <div class="day-header">${dayName} ${day.datum}</div>`;

                    for (const slot of day.slots) {
                        // Determine if this is the current slot
                        const now = new Date();
                        // Convert today to dd.mm.yyyy format to match backend data
                        const dd = String(now.getDate()).padStart(2, '0');
                        const mm = String(now.getMonth() + 1).padStart(2, '0');
                        const yyyy = now.getFullYear();
                        const today = `${dd}.${mm}.${yyyy}`;
                        const currentHour = now.getHours();

                        let isCurrent = false;
                        if (day.datum === today) {
                            if (slot.zeit === 'morgens' && currentHour >= 8 && currentHour < 12) {
                                isCurrent = true;
                            } else if (slot.zeit === 'nachmittags' && currentHour >= 13 && currentHour < 17) {
                                isCurrent = true;
                            } else if (slot.zeit === 'abends' && currentHour >= 19 && currentHour < 22) {
                                isCurrent = true;
                            }
                        }

                        const currentClass = isCurrent ? ' current-slot' : '';
                        const currentLabel = isCurrent ? ' <span class="current-badge">AKTUELL</span>' : '';

                        html += `<div class="slot ${slot.zeit}${currentClass}">
                            <div class="slot-label">${slot.zeit}${currentLabel}</div>`;

                        if (slot.task) {
                            // Extract title, removing prefix number and .md extension
                            const filename = slot.task.file.split('/').pop(); // Get only the filename
                            const titleMatch = filename.match(/^\d{4}-(.*)\.md$/);
                            const title = titleMatch ? titleMatch[1].replace(/-/g, ' ') : filename.replace(/^\d{4}/, '').replace(/\.md$/, '').replace(/-/g, ' ');
                            const num = extractTaskNumber(filename);

                            html += `<div class="task">[${num}] ${title}
                                <span class="badge">${slot.task.kategorie || '?'}</span>`;

                            if (slot.task.isFixed) {
                                html += `<span class="badge fixed">FIX</span>`;
                            }

                            // Add complete button
                            const taskFile = filename.replace('.md', '');
                            html += `<button class="complete-btn" onclick="completeTask('${taskFile}', '${day.datum}', '${slot.zeit}')">âœ“ Erledigt</button>`;

                            html += `</div>`;
                        } else {
                            html += `<div class="empty">â€“ leer â€“</div>`;
                        }

                        html += `</div>`;
                    }

                    html += `</div>`;
                }

                container.innerHTML = html;
                console.log('[Timeline] Rendered successfully');
            } catch (error) {
                console.error('[Timeline] Error:', error);
                container.innerHTML = `<div class="error">Fehler beim Laden: ${error.message}</div>`;
            } finally {
                hideLoading();
            }
        }

        async function completeTask(taskFile, date, slotTime) {
            console.log(`[CompleteTask] Completing task: ${taskFile} on ${date} in slot ${slotTime}`);
            showLoading();
            try {
                const apiUrl = `/api/tasks/${taskFile}/complete`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ datum: date, zeit: slotTime }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('[CompleteTask] Result:', result);
                alert('Task erfolgreich als abgeschlossen markiert!');
                // Reload timeline to reflect changes
                loadTimeline();
            } catch (error) {
                console.error('[CompleteTask] Error:', error);
                alert(`Fehler beim AbschlieÃŸen des Tasks: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function triggerFullSync() {
            console.log('[FullSync] Starting full sync...');
            showLoading();
            try {
                const apiUrl = '/sync?mode=full';

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('[FullSync] Result:', result);

                // Reload timeline with nocache=true to force rebuild
                console.log('[FullSync] Reloading timeline with cache bypass...');
                const timelineUrl = '/codex?nocache=true';
                const newResponse = await fetch(timelineUrl);
                if (!newResponse.ok) {
                    throw new Error(`HTTP error fetching timeline after sync! status: ${newResponse.status}`);
                }
                const newData = await newResponse.json();
                console.log('Reloaded timeline after sync:', newData);

                // Update nÃ¤chste ID Anzeige
                const nextIdDisplay = document.getElementById('nextIdDisplay');
                if (newData.nextAvailableId) {
                    const cacheTime = newData.cacheCreatedAt ? new Date(newData.cacheCreatedAt).toLocaleString('de-DE') : 'unbekannt';
                    nextIdDisplay.textContent = `NÃ¤chste Task-ID: ${newData.nextAvailableId} | Cache erstellt: ${cacheTime}`;
                }

                // Render Timeline neu
                let html = '';
                if (!newData.timeline || !Array.isArray(newData.timeline)) {
                    html = '<div class="empty">Keine Zeitachsen-Daten gefunden nach Sync.</div>';
                } else {
                    for (const day of newData.timeline || []) {
                        const dayName = dayNames[day.dayOfWeek];
                        html += `<div class="day">
                            <div class="day-header">${dayName} ${day.datum}</div>`;

                        for (const slot of day.slots) {
                            const now = new Date();
                            const dd = String(now.getDate()).padStart(2, '0');
                            const mm = String(now.getMonth() + 1).padStart(2, '0');
                            const yyyy = now.getFullYear();
                            const today = `${dd}.${mm}.${yyyy}`;
                            const currentHour = now.getHours();

                            let isCurrent = false;
                            if (day.datum === today) {
                                if (slot.zeit === 'morgens' && currentHour >= 8 && currentHour < 12) {
                                    isCurrent = true;
                                } else if (slot.zeit === 'nachmittags' && currentHour >= 13 && currentHour < 17) {
                                    isCurrent = true;
                                } else if (slot.zeit === 'abends' && currentHour >= 19 && currentHour < 22) {
                                    isCurrent = true;
                                }
                            }

                            const currentClass = isCurrent ? ' current-slot' : '';
                            const currentLabel = isCurrent ? ' <span class="current-badge">AKTUELL</span>' : '';

                            html += `<div class="slot ${slot.zeit}${currentClass}">
                                <div class="slot-label">${slot.zeit}${currentLabel}</div>`;

                            if (slot.task) {
                                const filename = slot.task.file.split('/').pop();
                                const titleMatch = filename.match(/^\d{4}-(.*)\.md$/);
                                const title = titleMatch ? titleMatch[1].replace(/-/g, ' ') : filename.replace(/^\d{4}/, '').replace(/\.md$/, '').replace(/-/g, ' ');
                                const num = extractTaskNumber(filename);

                                html += `<div class="task">[${num}] ${title}
                                    <span class="badge">${slot.task.kategorie || '?'}</span>`;

                                if (slot.task.isFixed) {
                                    html += `<span class="badge fixed">FIX</span>`;
                                }

                                const taskFile = filename.replace('.md', '');
                                html += `<button class="complete-btn" onclick="completeTask('${taskFile}', '${day.datum}', '${slot.zeit}')">âœ“ Erledigt</button>`;

                                html += `</div>`;
                            } else {
                                html += `<div class="empty">â€“ leer â€“</div>`;
                            }

                            html += `</div>`;
                        }
                        html += `</div>`;
                    }
                }

                document.getElementById('timeline').innerHTML = html;
                alert(`Full Sync erfolgreich! ${result.changed} Tasks synchronisiert. Timeline neu aufgebaut.`);

            } catch (error) {
                console.error('[FullSync] Error:', error);
                alert(`Fehler beim Full Sync: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // Setup Full Sync button and Create Task link
        document.addEventListener('DOMContentLoaded', () => {
            const fullSyncBtn = document.getElementById('fullSyncBtn');
            if (fullSyncBtn) {
                fullSyncBtn.addEventListener('click', triggerFullSync);
            }
            
            // Setup Logout button
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    // Redirect to login page
                    window.location.href = '/login.html';
                });
            }

            // Set create task link
            const createTaskLink = document.getElementById('createTaskLink');
            if (createTaskLink) {
                createTaskLink.href = '/create-task.html';
            }
        });

        console.log('[Timeline] Initializing...');
        try {
            loadTimeline();
        } catch (err) {
            console.error('[Timeline] Failed to initialize:', err);
            document.getElementById('timeline').innerHTML = `<div class="error">Initialisierungsfehler: ${err.message}</div>`;
        }
    </script>
</body>
</html>