<!DOCTYPE html><!DOCTYPE html><!DOCTYPE html>

<html lang="de">

<head><html lang="de"><html lang="de">

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0"><head><head>

    <title>CodexMiroir Timeline</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">    <meta charset="UTF-8">    <meta charset="UTF-8">

    <link rel="stylesheet" href="styles.css">

    <script src="app.js"></script>    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>

</head>    <title>CodexMiroir Timeline</title>    <title>CodexMiroir Timeline</title>

<body x-data="app" x-init="load()">

    <main class="container">    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">

        <header>

            <h1>CodexMiroir Timeline</h1>    <link rel="stylesheet" href="styles.css">    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>

            <p>Task-Management & Timeline-Verwaltung</p>

        </header>    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>    <style>



        <!-- Konfiguration -->    <script defer src="app.js"></script>        .day { border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; border-radius: 0.5rem; }

        <section>

            <h2>Konfiguration</h2></head>        .slot { padding: 0.5rem; margin: 0.5rem 0; border-left: 3px solid var(--primary); background: var(--card-background-color); }

            <form @submit.prevent="load()">

                <div class="grid"><body x-data="app" x-init="load()">        .slot.empty { opacity: 0.5; border-left-color: #ccc; }

                    <label>

                        User ID    <main class="container">        .slot.locked { border-left-color: #d9534f; }

                        <input type="text" x-model="userId" placeholder="User ID" required>

                    </label>        <h1>CodexMiroir Timeline</h1>        .btn-sm { font-size: 0.75rem; padding: 0.25rem 0.5rem; margin: 0.25rem; }

                    <label>

                        Von            </style>

                        <input type="date" x-model="dateFrom">

                    </label>        <!-- Config --></head>

                    <label>

                        Bis        <section><body x-data="app" x-init="load()">

                        <input type="date" x-model="dateTo">

                    </label>            <div class="grid">    <main class="container">

                </div>

                <button type="submit">Timeline laden</button>                <input type="text" x-model="userId" placeholder="User ID (z.B. u_merlin)">        <h1>CodexMiroir Timeline</h1>

            </form>

        </section>                <input type="date" x-model="dateFrom">        



        <!-- Fehler-Anzeige -->                <input type="date" x-model="dateTo">        <!-- Config -->

        <div x-show="error" role="alert" x-text="error" style="display: none;"></div>

                <button @click="load">Laden</button>        <section>

        <!-- Aktionen -->

        <section>            </div>            <div class="grid">

            <h2>Aktionen</h2>

            <div class="grid">        </section>                <input type="text" x-model="userId" placeholder="User ID (z.B. u_merlin)">

                <button @click="create()">Task erstellen</button>

                <button @click="load()">Timeline neu laden</button>                <input type="date" x-model="dateFrom">

            </div>

        </section>        <!-- Error -->                <input type="date" x-model="dateTo">



        <!-- Timeline -->        <div x-show="error" role="alert" x-text="error"></div>                <button @click="load">Laden</button>

        <section x-show="days.length" style="display: none;">

            <h2>Timeline</h2>            </div>

            <template x-for="day in days" :key="day.id">

                <article class="day">        <!-- Timeline -->        </section>

                    <header>

                        <strong x-text="fmtDate(day.date)"></strong>        <section x-show="days.length">

                        <small x-text="'KW ' + fmtKW(day.date)"></small>

                    </header>            <h2>Timeline</h2>        <!-- Error -->

                    

                    <template x-for="(slot, idx) in ['morgens', 'mittags', 'abends']" :key="idx">            <template x-for="day in days" :key="day.id">        <div x-show="error" role="alert" x-text="error"></div>

                        <div class="slot">

                            <div class="grid">                <div class="day">

                                <div>

                                    <strong x-text="slot.charAt(0).toUpperCase() + slot.slice(1)"></strong>                    <h4 x-text="format(day.date) + ' (KW ' + week(day.date) + ')'"></h4>        <!-- Timeline -->

                                    <span x-show="day[slot]?.manualOnly" style="color: var(--del-color)"> üîí</span>

                                </div>                    <template x-for="slot in day.slots" :key="slot.idx">        <section x-show="days.length">

                                <div x-show="day[slot]?.task">

                                    <span x-text="day[slot]?.task?.title || '‚Äî'"></span>                        <div class="slot" :class="{empty: !slot.assignment.taskId, locked: slot.locked}">            <h2>Timeline</h2>

                                    <small x-show="day[slot]?.task?.kind" 

                                           x-text="'(' + day[slot]?.task?.kind + ')'"                             <strong x-text="label(slot.label)"></strong>            <template x-for="day in days" :key="day.id">

                                           style="margin-left: 0.5rem;"></small>

                                </div>                            <template x-if="slot.assignment.taskId">                <div class="day">

                            </div>

                            <div class="grid">                                <div>                    <h4 x-text="format(day.date) + ' (KW ' + week(day.date) + ')'"></h4>

                                <button class="btn-sm" 

                                        @click="assign(day.date, slot, prompt('Task ID:'))"                                    <p>                    <template x-for="slot in day.slots" :key="slot.idx">

                                        x-show="!day[slot]?.manualOnly || !day[slot]?.task">

                                    Zuweisen                                        <strong x-text="slot.assignment.taskId"></strong>                         <div class="slot" :class="{empty: !slot.assignment.taskId, locked: slot.locked}">

                                </button>

                                <button class="btn-sm"                                         (<span x-text="kind(slot.assignment.kind)"></span>)                            <strong x-text="label(slot.label)"></strong>

                                        @click="edit(day[slot]?.task)" 

                                        x-show="day[slot]?.task">                                    </p>                            <template x-if="slot.assignment.taskId">

                                    Bearbeiten

                                </button>                                    <button class="btn-sm secondary" @click="prio(slot.assignment.taskId)">‚¨Ü Priorisieren</button>                                <div>

                                <button class="btn-sm" 

                                        @click="prio(day[slot]?.task?.id)"                                     <button class="btn-sm contrast" @click="edit(slot.assignment.taskId)">‚úè Bearbeiten</button>                                    <p>

                                        x-show="day[slot]?.task">

                                    Priorisieren                                </div>                                        <strong x-text="slot.assignment.taskId"></strong> 

                                </button>

                            </div>                            </template>                                        (<span x-text="kind(slot.assignment.kind)"></span>)

                        </div>

                    </template>                            <template x-if="!slot.assignment.taskId && !slot.locked">                                    </p>

                </article>

            </template>                                <button class="btn-sm" @click="create(day.date, slot.idx)">+ Task zuweisen</button>                                    <button class="btn-sm secondary" @click="prio(slot.assignment.taskId)">‚¨Ü Priorisieren</button>

        </section>

                            </template>                                    <button class="btn-sm contrast" @click="edit(slot.assignment.taskId)">‚úè Bearbeiten</button>

        <!-- Dialog -->

        <dialog :open="dialog.show">                        </div>                                </div>

            <article>

                <header>                    </template>                            </template>

                    <h3 x-text="dialog.mode === 'edit' ? 'Task bearbeiten' : 'Task erstellen'"></h3>

                </header>                </div>                            <template x-if="!slot.assignment.taskId && !slot.locked">

                <form @submit.prevent="save()">

                    <div class="grid">            </template>                                <button class="btn-sm" @click="create(day.date, slot.idx)">+ Task zuweisen</button>

                        <label>

                            Task ID        </section>                            </template>

                            <input type="text" x-model="task.id" placeholder="Task ID" :disabled="dialog.mode === 'edit'" required>

                        </label>                        </div>

                        <label>

                            Titel        <!-- Task Dialog -->                    </template>

                            <input type="text" x-model="task.title" placeholder="Titel" required>

                        </label>        <dialog :open="dialog.show">                </div>

                        <label>

                            Art            <article>            </template>

                            <select x-model="task.kind" required>

                                <option value="">Bitte w√§hlen</option>                <header>        </section>

                                <option value="task">Task</option>

                                <option value="appointment">Termin</option>                    <button aria-label="Close" @click="dialog.show = false"></button>

                                <option value="meeting">Meeting</option>

                                <option value="break">Pause</option>                    <h3 x-text="dialog.mode === 'edit' ? 'Task bearbeiten' : 'Task erstellen'"></h3>        <!-- Task Dialog -->

                                <option value="other">Sonstiges</option>

                            </select>                </header>        <dialog :open="dialog.show">

                        </label>

                    </div>                <form @submit.prevent="save">            <article>

                    

                    <label>                    <input type="text" x-model="task.id" placeholder="Task ID" :disabled="dialog.mode === 'edit'" required>                <header>

                        Beschreibung

                        <textarea x-model="task.description" placeholder="Beschreibung" rows="3"></textarea>                    <select x-model="task.kind" required>                    <button aria-label="Close" @click="dialog.show = false"></button>

                    </label>

                                            <option value="">Art w√§hlen</option>                    <h3 x-text="dialog.mode === 'edit' ? 'Task bearbeiten' : 'Task erstellen'"></h3>

                    <div class="grid">

                        <label>                        <option value="business">Gesch√§ftlich</option>                </header>

                            Tags (kommagetrennt)

                            <input type="text" x-model="task.tags" placeholder="Tags (kommagetrennt)">                        <option value="personal">Privat</option>                <form @submit.prevent="save">

                        </label>

                        <label>                    </select>                    <input type="text" x-model="task.id" placeholder="Task ID" :disabled="dialog.mode === 'edit'" required>

                            Priorit√§t (1-5)

                            <input type="number" x-model="task.priority" placeholder="Priorit√§t (1-5)" min="1" max="5">                    <input type="text" x-model="task.title" placeholder="Titel" required>                    <select x-model="task.kind" required>

                        </label>

                        <label>                    <textarea x-model="task.description" placeholder="Beschreibung" rows="3"></textarea>                        <option value="">Art w√§hlen</option>

                            Deadline

                            <input type="date" x-model="task.deadline" placeholder="Deadline">                                            <option value="business">Gesch√§ftlich</option>

                        </label>

                    </div>                    <details>                        <option value="personal">Privat</option>

                    

                    <div class="grid">                        <summary>Erweitert</summary>                    </select>

                        <label>

                            <input type="checkbox" x-model="task.fixed">                        <input type="text" x-model="task.tags" placeholder="Tags (kommagetrennt)">                    <input type="text" x-model="task.title" placeholder="Titel" required>

                            Fix (nicht verschiebbar)

                        </label>                        <input type="number" x-model="task.priority" placeholder="Priorit√§t (1-5)" min="1" max="5">                    <textarea x-model="task.description" placeholder="Beschreibung" rows="3"></textarea>

                        <label>

                            Projekt ID                        <input type="date" x-model="task.deadline" placeholder="Deadline">                    

                            <input type="text" x-model="task.projectId" placeholder="Projekt ID">

                        </label>                        <label><input type="checkbox" x-model="task.fixed"> Fester Termin</label>                    <details>

                        <label>

                            Projekt Name                        <input type="text" x-model="task.projectId" placeholder="Projekt ID">                        <summary>Erweitert</summary>

                            <input type="text" x-model="task.projectName" placeholder="Projekt Name">

                        </label>                        <input type="text" x-model="task.projectName" placeholder="Projekt Name">                        <input type="text" x-model="task.tags" placeholder="Tags (kommagetrennt)">

                    </div>

                                            <input type="text" x-model="task.contactName" placeholder="Kontakt Name">                        <input type="number" x-model="task.priority" placeholder="Priorit√§t (1-5)" min="1" max="5">

                    <div class="grid">

                        <label>                        <input type="email" x-model="task.contactEmail" placeholder="Kontakt Email">                        <input type="date" x-model="task.deadline" placeholder="Deadline">

                            Kontakt Name

                            <input type="text" x-model="task.contactName" placeholder="Kontakt Name">                        <input type="url" x-model="task.devOpsUrl" placeholder="DevOps URL">                        <label><input type="checkbox" x-model="task.fixed"> Fester Termin</label>

                        </label>

                        <label>                    </details>                        <input type="text" x-model="task.projectId" placeholder="Projekt ID">

                            Kontakt Email

                            <input type="email" x-model="task.contactEmail" placeholder="Kontakt Email">                                            <input type="text" x-model="task.projectName" placeholder="Projekt Name">

                        </label>

                        <label>                    <footer>                        <input type="text" x-model="task.contactName" placeholder="Kontakt Name">

                            DevOps URL

                            <input type="url" x-model="task.devOpsUrl" placeholder="DevOps URL">                        <button type="button" class="secondary" @click="dialog.show = false">Abbrechen</button>                        <input type="email" x-model="task.contactEmail" placeholder="Kontakt Email">

                        </label>

                    </div>                        <button type="submit">Speichern</button>                        <input type="url" x-model="task.devOpsUrl" placeholder="DevOps URL">

                    

                    <footer>                    </footer>                    </details>

                        <button type="button" @click="dialog.show = false" class="secondary">Abbrechen</button>

                        <button type="submit">Speichern</button>                </form>                    

                    </footer>

                </form>            </article>                    <footer>

            </article>

        </dialog>        </dialog>                        <button type="button" class="secondary" @click="dialog.show = false">Abbrechen</button>



        <!-- Quick-AutoFill -->                        <button type="submit">Speichern</button>

        <section>

            <h2>Quick AutoFill</h2>        <!-- Quick AutoFill -->                    </footer>

            <form @submit.prevent="autofill()">

                <div class="grid">        <section>                </form>

                    <label>

                        Task ID            <h3>Schnell-Task + AutoFill</h3>            </article>

                        <input type="text" x-model="quick.id" placeholder="Task ID" required>

                    </label>            <form @submit.prevent="autofill" class="grid">        </dialog>

                    <label>

                        Titel                <input type="text" x-model="quick.id" placeholder="Task ID" required>

                        <input type="text" x-model="quick.title" placeholder="Titel" required>

                    </label>                <select x-model="quick.kind" required>        <!-- Quick AutoFill -->

                    <label>

                        Art                    <option value="">Art</option>        <section>

                        <select x-model="quick.kind" required>

                            <option value="">Bitte w√§hlen</option>                    <option value="business">Gesch√§ftlich</option>            <h3>Schnell-Task + AutoFill</h3>

                            <option value="task">Task</option>

                            <option value="appointment">Termin</option>                    <option value="personal">Privat</option>            <form @submit.prevent="autofill" class="grid">

                            <option value="meeting">Meeting</option>

                            <option value="break">Pause</option>                </select>                <input type="text" x-model="quick.id" placeholder="Task ID" required>

                            <option value="other">Sonstiges</option>

                        </select>                <input type="text" x-model="quick.title" placeholder="Titel" required>                <select x-model="quick.kind" required>

                    </label>

                    <label>                <input type="date" x-model="quick.date" required>                    <option value="">Art</option>

                        Ab Datum

                        <input type="date" x-model="quick.date" required>                <button type="submit">Erstellen & AutoFill</button>                    <option value="business">Gesch√§ftlich</option>

                    </label>

                </div>            </form>                    <option value="personal">Privat</option>

                <button type="submit">Task erstellen & automatisch zuweisen</button>

            </form>        </section>                </select>

        </section>

    </main>    </main>                <input type="text" x-model="quick.title" placeholder="Titel" required>

</body>

</html></body>                <input type="date" x-model="quick.date" required>


</html>                <button type="submit">Erstellen & AutoFill</button>

            </form>
        </section>
    </main>

    <script>
        const BASE = 'http://localhost:7071';
        
        document.addEventListener('alpine:init', () => {
            Alpine.data('app', () => ({
                userId: 'u_merlin',
                dateFrom: new Date().toISOString().split('T')[0],
                dateTo: new Date(Date.now() + 7*86400000).toISOString().split('T')[0],
                days: [],
                error: null,
                dialog: { show: false, mode: 'create', date: '', slot: null },
                task: this.emptyTask(),
                quick: { id: '', kind: '', title: '', date: new Date().toISOString().split('T')[0] },
                
                emptyTask() {
                    return { id: 'task_' + Date.now(), kind: 'business', title: '', description: '', tags: '', 
                             priority: 3, deadline: '', fixed: false, projectId: '', projectName: '', 
                             contactName: '', contactEmail: '', devOpsUrl: '' };
                },
                
                async load() {
                    try {
                        this.error = null;
                        const res = await fetch(`${BASE}/timeline/${this.userId}?dateFrom=${this.dateFrom}&dateTo=${this.dateTo}`);
                        if (!res.ok) throw new Error('HTTP ' + res.status);
                        const data = await res.json();
                        this.days = data.days || [];
                    } catch (e) {
                        this.error = e.message;
                    }
                },
                
                create(date, slotIdx) {
                    this.dialog = { show: true, mode: 'create', date, slot: slotIdx };
                    this.task = this.emptyTask();
                },
                
                async edit(taskId) {
                    try {
                        this.error = null;
                        const res = await fetch(`${BASE}/tasks/${this.userId}/${taskId}`);
                        if (!res.ok) throw new Error('HTTP ' + res.status);
                        const data = await res.json();
                        this.task = {
                            id: data.id, kind: data.kind, title: data.title || '', description: data.description || '',
                            tags: (data.tags || []).join(', '), priority: data.priority || 3,
                            deadline: data.deadline || '', fixed: data.fixed || false,
                            projectId: data.project?.id || '', projectName: data.project?.name || '',
                            contactName: data.contact?.name || '', contactEmail: data.contact?.email || '',
                            devOpsUrl: data.external?.devOpsUrl || ''
                        };
                        this.dialog = { show: true, mode: 'edit', date: '', slot: null };
                    } catch (e) {
                        this.error = e.message;
                    }
                },
                
                async save() {
                    try {
                        this.error = null;
                        const payload = {
                            id: this.task.id, kind: this.task.kind, title: this.task.title,
                            description: this.task.description, priority: this.task.priority,
                            tags: this.task.tags.split(',').map(t => t.trim()).filter(t => t),
                            deadline: this.task.deadline || null, fixed: this.task.fixed
                        };
                        if (this.task.projectId || this.task.projectName) {
                            payload.project = { id: this.task.projectId || null, name: this.task.projectName || null };
                        }
                        if (this.task.contactName || this.task.contactEmail) {
                            payload.contact = { name: this.task.contactName || null, email: this.task.contactEmail || null };
                        }
                        if (this.task.devOpsUrl) {
                            payload.external = { devOpsUrl: this.task.devOpsUrl, calendarEventId: null };
                        }
                        
                        if (this.dialog.mode === 'edit') {
                            const res = await fetch(`${BASE}/tasks/${this.userId}/${this.task.id}`, {
                                method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                            });
                            if (!res.ok) throw new Error('Update failed: HTTP ' + res.status);
                        } else {
                            const res1 = await fetch(`${BASE}/tasks/${this.userId}`, {
                                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                            });
                            if (!res1.ok) throw new Error('Create failed: HTTP ' + res1.status);
                            
                            const res2 = await fetch(`${BASE}/timeline/${this.userId}/assign`, {
                                method: 'POST', headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    date: this.dialog.date, slotIdx: this.dialog.slot,
                                    task: { id: this.task.id, kind: this.task.kind, title: this.task.title }, source: 'manual'
                                })
                            });
                            if (!res2.ok) throw new Error('Assign failed: HTTP ' + res2.status);
                        }
                        
                        this.dialog.show = false;
                        await this.load();
                    } catch (e) {
                        this.error = e.message;
                    }
                },
                
                async prio(taskId) {
                    try {
                        this.error = null;
                        const res = await fetch(`${BASE}/timeline/${this.userId}/prioritize`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ taskId })
                        });
                        if (!res.ok) throw new Error('HTTP ' + res.status);
                        await this.load();
                    } catch (e) {
                        this.error = e.message;
                    }
                },
                
                async autofill() {
                    try {
                        this.error = null;
                        const res1 = await fetch(`${BASE}/tasks/${this.userId}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ id: this.quick.id, kind: this.quick.kind, title: this.quick.title, priority: 3 })
                        });
                        if (!res1.ok) throw new Error('Create failed: HTTP ' + res1.status);
                        
                        const res2 = await fetch(`${BASE}/timeline/${this.userId}/autofill`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ dateFrom: this.quick.date, task: { id: this.quick.id, kind: this.quick.kind, title: this.quick.title } })
                        });
                        if (!res2.ok) throw new Error('AutoFill failed: HTTP ' + res2.status);
                        
                        this.quick = { id: '', kind: '', title: '', date: new Date().toISOString().split('T')[0] };
                        await this.load();
                    } catch (e) {
                        this.error = e.message;
                    }
                },
                
                format(d) {
                    const date = new Date(d + 'T00:00:00');
                    return date.toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                },
                
                week(d) {
                    const date = new Date(d + 'T00:00:00Z');
                    const day = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
                    const dayNum = day.getUTCDay() || 7;
                    day.setUTCDate(day.getUTCDate() + 4 - dayNum);
                    const yearStart = new Date(Date.UTC(day.getUTCFullYear(), 0, 1));
                    return Math.ceil((((day - yearStart) / 86400000) + 1) / 7);
                },
                
                label(l) {
                    return { AM: 'Morgens', PM: 'Mittags', EV: 'Abends' }[l] || l;
                },
                
                kind(k) {
                    return { business: 'Gesch√§ftlich', personal: 'Privat', work: 'Gesch√§ftlich' }[k] || k;
                }
            }));
        });
    </script>
</body>
</html>
