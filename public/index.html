<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodexMiroir Timeline</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <link rel="stylesheet" href="styles.css">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>
    <script defer src="app.js"></script>
</head>
<body x-data="app" x-init="init()">
    <main class="container">
        <header>
            <h1>CodexMiroir Timeline</h1>
            <p>Task-Management & Timeline-Verwaltung</p>
        </header>

        <!-- Konfiguration -->
        <section>
            <h2>Konfiguration</h2>
            <div class="grid">
                <label>
                    Benutzername
                    <input type="text" x-model="userId" placeholder="z.B. u_merlin">
                </label>
                <label>
                    Backend-URL
                    <input type="text" x-model="backendUrl" placeholder="http://localhost:7071">
                </label>
            </div>
            <button @click="load()">Timeline laden</button>
        </section>

        <!-- Fehler-Anzeige -->
        <div x-show="error" role="alert" x-text="error" style="color: red; padding: 1rem; margin: 1rem 0;"></div>

        <!-- Timeline -->
        <section x-show="days.length">
            <h2>Timeline</h2>
            <template x-for="day in days" :key="day.date">
                <article class="day">
                    <header>
                        <strong x-text="format(day.date)"></strong>
                        <small x-text="'KW ' + week(day.date)"></small>
                    </header>
                    
                    <template x-for="slot in day.slots" :key="slot.idx">
                        <div class="slot" :class="{empty: !slot.assignment.taskId, locked: slot.locked}">
                            <div class="grid">
                                <div>
                                    <strong x-text="label(slot.label)"></strong>
                                </div>
                                <div>
                                    <template x-if="slot.assignment.taskId">
                                        <div>
                                            <p>
                                                <strong x-text="slot.assignment.taskId"></strong> 
                                                (<span x-text="kind(slot.assignment.kind)"></span>)
                                            </p>
                                            <button class="btn-sm secondary" @click="prio(slot.assignment.taskId)">⬆ Priorisieren</button>
                                            <button class="btn-sm contrast" @click="edit(slot.assignment.taskId)">✏ Bearbeiten</button>
                                        </div>
                                    </template>
                                    <template x-if="!slot.assignment.taskId && !slot.locked">
                                        <button class="btn-sm" @click="create(day.date, slot.idx)">+ Task zuweisen</button>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>
                </article>
            </template>
        </section>

        <!-- Task Dialog -->
        <dialog :open="dialog.show">
            <article>
                <header>
                    <button aria-label="Close" @click="dialog.show = false"></button>
                    <h3 x-text="dialog.mode === 'edit' ? 'Task bearbeiten' : 'Task erstellen'"></h3>
                </header>
                <form @submit.prevent="save">
                    <label>
                        Titel
                        <input type="text" x-model="task.title" placeholder="Titel" required>
                    </label>

                    <label>
                        Beschreibung
                        <textarea x-model="task.description" placeholder="Beschreibung" rows="3"></textarea>
                    </label>

                    <label>
                        Typ
                        <select x-model="task.kind" required>
                            <option value="business">Geschäftlich</option>
                            <option value="personal">Privat</option>
                        </select>
                    </label>

                    <label>
                        Deadline
                        <input type="date" x-model="task.deadline">
                    </label>

                    <label>
                        <input type="checkbox" x-model="task.fixed">
                        Fester Termin
                    </label>

                    <template x-if="task.fixed">
                        <div class="grid">
                            <label>
                                Datum
                                <input type="date" x-model="task.fixedDate">
                            </label>
                            <label>
                                Uhrzeit
                                <input type="time" x-model="task.fixedTime">
                            </label>
                        </div>
                    </template>

                    <footer>
                        <button type="button" class="secondary" @click="dialog.show = false">Abbrechen</button>
                        <button type="submit">Speichern</button>
                    </footer>
                </form>
            </article>
        </dialog>
    </main>
</body>
</html>
